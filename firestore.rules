rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check user roles
    function hasRole(role) {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Raw Ingest Collection - Write access for crawlers, read for all authenticated
    match /raw_ingest/{document} {
      allow read: if isAuthenticated();
      allow write: if hasRole('admin') || hasRole('crawler');
      allow update: if hasRole('annotator') || hasRole('expert') || hasRole('admin');
    }
    
    // Curated Corpus - Read for authenticated, write for experts/admins
    match /curated_corpus/{document} {
      allow read: if isAuthenticated();
      allow write: if hasRole('expert') || hasRole('admin');
      allow create: if hasRole('expert') || hasRole('admin');
      allow delete: if hasRole('admin');
    }
    
    // Audit Logs - Read-only except for system writes
    match /audit_logs/{document} {
      allow read: if hasRole('admin');
      allow write: if hasRole('admin');
    }
    
    // Crawl Queue - Managed by crawler agents
    match /crawl_queue/{document} {
      allow read: if isAuthenticated();
      allow write: if hasRole('admin') || hasRole('crawler');
    }
    
    // Annotations - Annotators can write, experts can approve
    match /annotations/{document} {
      allow read: if isAuthenticated();
      allow create: if hasRole('annotator') || hasRole('expert') || hasRole('admin');
      allow update: if hasRole('expert') || hasRole('admin');
      allow delete: if hasRole('admin');
    }
    
    // User Management - Admins only
    match /users/{userId} {
      allow read: if request.auth.uid == userId || hasRole('admin');
      allow write: if hasRole('admin');
    }
    
    // Medical Ontology - Read for all, write for admins
    match /ontology_diseases/{document} {
      allow read: if isAuthenticated();
      allow write: if hasRole('admin');
    }
    
    match /ontology_symptoms/{document} {
      allow read: if isAuthenticated();
      allow write: if hasRole('admin');
    }
    
    match /ontology_facilities/{document} {
      allow read: if isAuthenticated();
      allow write: if hasRole('admin');
    }
    
    // Clinic Schedules - Public read, admin write
    match /clinic_schedules/{document} {
      allow read: if true; // Public read
      allow write: if hasRole('admin') || hasRole('expert');
    }
    
    // Bias Metrics - Admin only
    match /bias_metrics/{document} {
      allow read: if hasRole('admin');
      allow write: if hasRole('admin');
    }
  }
}
